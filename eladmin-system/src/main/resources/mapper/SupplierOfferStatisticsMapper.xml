<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="me.zhengjie.modules.statistics.service.mapper.SupplierOfferStatisticsMapper">

  <!-- 通用查询结果列 -->
  <!--
  <sql id="Base_Column_List">
      a.id, a.good_id, a.wh_id, a.count
  </sql>
  -->

    <select id="queryAll" resultType="me.zhengjie.modules.statistics.service.dto.SupplierOfferStatisticsDto">
        SELECT p.id, p.c_name AS source_name, SUM(po.amount_count) AS purchase_count, SUM(po.amount_price) AS purchase_amount,
             SUM(pro.amount_count) AS refund_count, SUM(pro.amount_price) AS refund_amount,
             (SUM(po.amount_count) - SUM(pro.amount_count)) AS total_count, (SUM(po.amount_price) - SUM(pro.amount_price)) AS total_amount
        FROM tb_partner_company_info p
             LEFT JOIN tb_orders po ON po.source_id = p.id AND po.order_type = 1
             LEFT JOIN tb_orders pro ON pro.source_id = p.id AND pro.order_type = 4
        WHERE p.type IN (1,3)
        <if test="query.sourceName != null and query.sourceName != ''">
            AND p.c_name LIKE CONCAT('%', #{query.sourceName}, '%')
        </if>
        GROUP BY p.id
    </select>

    <select id="getDetail" resultType="me.zhengjie.modules.statistics.service.dto.SupplierOfferDetailDto">
        SELECT o.order_no, o.date, g.g_code, g.g_name, g.specification, g.py_code, u.gu_name AS unitName,
               og.price, og.good_num AS count, og.total_price, w.wh_name, c.c_name AS source_name
        FROM tb_orders o
             LEFT JOIN tb_order_goods og ON og.order_id = o.id
             LEFT JOIN tb_goods_info g ON g.id = og.good_id
             LEFT JOIN tb_goods_unit u ON u.id = g.unit
             LEFT JOIN tb_warehouse w ON w.wh_id = o.wh_id
             LEFT JOIN tb_partner_company_info c ON c.id = o.source_id
        WHERE o.order_type = 1 AND o.status = 2
        <if test="sourceId != null and sourceId != ''">
            AND c.id = #{sourceId}
        </if>
        ORDER BY o.order_date DESC
    </select>
</mapper>
